name: PR Merge Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

# Configuration: Update these branch names per release cycle
env:
  PRIMARY_BRANCH: 'master'
  RELEASE_BRANCH: 'release-5.2.1'

jobs:
  validate-cross-branch-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract parent issue reference
        id: extract_issue
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_TEXT="$PR_TITLE $PR_BODY"
          
          # Extract issue reference using regex pattern (#54321)
          ISSUE_REF=$(echo "$PR_TEXT" | grep -oP '#\d+' | head -1)
          
          if [ -z "$ISSUE_REF" ]; then
            echo "No parent issue reference found in PR"
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "Found issue reference: $ISSUE_REF"
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_ref=$ISSUE_REF" >> $GITHUB_OUTPUT
          fi

      - name: Determine target and comparison branches
        id: branches
        run: |
          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          
          if [ "$TARGET_BRANCH" == "${{ env.PRIMARY_BRANCH }}" ]; then
            COMPARE_BRANCH="${{ env.RELEASE_BRANCH }}"
          elif [ "$TARGET_BRANCH" == "${{ env.RELEASE_BRANCH }}" ]; then
            COMPARE_BRANCH="${{ env.PRIMARY_BRANCH }}"
          else
            echo "PR target branch is not one of the monitored branches"
            echo "should_validate=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "compare_branch=$COMPARE_BRANCH" >> $GITHUB_OUTPUT
          echo "should_validate=true" >> $GITHUB_OUTPUT

      - name: Search for matching PR in other branch
        id: search_pr
        if: steps.extract_issue.outputs.has_issue == 'true' && steps.branches.outputs.should_validate == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_REF="${{ steps.extract_issue.outputs.issue_ref }}"
          COMPARE_BRANCH="${{ steps.branches.outputs.compare_branch }}"
          REPO="${{ github.repository }}"
          
          echo "Searching for open PRs in branch '$COMPARE_BRANCH' with issue reference '$ISSUE_REF'"
          
          # Search for open PRs targeting the comparison branch
          MATCHING_PRS=$(gh pr list \
            --repo "$REPO" \
            --base "$COMPARE_BRANCH" \
            --state open \
            --json number,title,body \
            --jq ".[] | select(.title + .body | contains(\"$ISSUE_REF\")) | .number" \
            | head -1)
          
          if [ -z "$MATCHING_PRS" ]; then
            echo "No matching PR found in branch '$COMPARE_BRANCH'"
            echo "matching_pr_found=false" >> $GITHUB_OUTPUT
          else
            echo "Found matching PR #$MATCHING_PRS in branch '$COMPARE_BRANCH'"
            echo "matching_pr_found=true" >> $GITHUB_OUTPUT
            echo "matching_pr_number=$MATCHING_PRS" >> $GITHUB_OUTPUT
          fi

      - name: Post validation result
        if: steps.extract_issue.outputs.has_issue == 'true' && steps.branches.outputs.should_validate == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const matchingPrFound = '${{ steps.search_pr.outputs.matching_pr_found }}' === 'true';
            const issueRef = '${{ steps.extract_issue.outputs.issue_ref }}';
            const targetBranch = '${{ steps.branches.outputs.target_branch }}';
            const compareBranch = '${{ steps.branches.outputs.compare_branch }}';
            const matchingPrNumber = '${{ steps.search_pr.outputs.matching_pr_number }}';
            
            let commentBody;
            
            if (matchingPrFound) {
              commentBody = `✅ **Cross-Branch Validation: PASSED**
              
              This PR references issue ${issueRef} and a corresponding PR (#${matchingPrNumber}) exists in the \`${compareBranch}\` branch with the same issue reference.
              
              **Status:** Merge validation successful - both branches will receive this fix.`;
              
              // Remove any existing blocking labels
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: 'merge-blocked:missing-cross-branch-pr'
                });
              } catch (error) {
                // Label might not exist, ignore
              }
              
            } else {
              commentBody = `⚠️ **Cross-Branch Validation: REQUIRES REVIEW**
              
              This PR references issue ${issueRef} but **no corresponding PR** was found in the \`${compareBranch}\` branch with the same issue reference.
              
              **⚠️ MERGE BLOCKED - REVIEWER ACTION REQUIRED**
              
              ---
              
              ### Override Instructions
              
              If this fix is intentionally being merged into **only** the \`${targetBranch}\` branch, a reviewer must:
              
              1. **Acknowledge the risk** of potential inconsistency between branches
              2. **Add the label** \`approved:single-branch-merge\` to this PR
              3. **Comment** with justification for the single-branch merge
              
              **Example justification:**
              > "Approved for single-branch merge. This fix is specific to ${targetBranch} and does not apply to ${compareBranch} because [reason]."
              
              ---
              
              ### Creating a Matching PR
              
              Alternatively, create a PR for \`${compareBranch}\` that:
              - References the same issue ${issueRef}
              - Contains the equivalent fix for that branch
              
              Once the matching PR is created, re-run this workflow by updating this PR.`;
              
              // Add blocking label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['merge-blocked:missing-cross-branch-pr']
              });
            }
            
            // Post or update comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Cross-Branch Validation')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Check for override approval
        id: check_override
        if: steps.search_pr.outputs.matching_pr_found == 'false' && steps.branches.outputs.should_validate == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasOverride = labels.includes('approved:single-branch-merge');
            
            if (hasOverride) {
              console.log('Override label found - allowing merge to proceed');
              core.setOutput('override_approved', 'true');
            } else {
              console.log('No override label found - blocking merge');
              core.setOutput('override_approved', 'false');
            }
            
            return hasOverride;

      - name: Block merge if validation fails
        if: |
          steps.extract_issue.outputs.has_issue == 'true' && 
          steps.branches.outputs.should_validate == 'true' &&
          steps.search_pr.outputs.matching_pr_found == 'false' &&
          steps.check_override.outputs.override_approved != 'true'
        run: |
          echo "::error::Cross-branch PR validation failed. No matching PR found in ${{ steps.branches.outputs.compare_branch }} branch."
          echo "::error::A reviewer must add the 'approved:single-branch-merge' label to override this check."
          exit 1

      - name: Validation summary
        if: always()
        run: |
          echo "=== PR Merge Validation Summary ==="
          echo "Target Branch: ${{ steps.branches.outputs.target_branch }}"
          echo "Comparison Branch: ${{ steps.branches.outputs.compare_branch }}"
          echo "Issue Reference: ${{ steps.extract_issue.outputs.issue_ref }}"
          echo "Matching PR Found: ${{ steps.search_pr.outputs.matching_pr_found }}"
          echo "Override Approved: ${{ steps.check_override.outputs.override_approved }}"

# Made with Bob
